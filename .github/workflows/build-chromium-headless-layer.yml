name: Build Python Playwright + Chromium Lambda Layers

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-layers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip brotli zip curl jq tar

      - name: Download latest Sparticuz Chromium release
        run: |
          RELEASE_JSON=$(curl -s https://api.github.com/repos/Sparticuz/chromium/releases/latest)
          CHROME_ZIP_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("layer\\.x64\\.zip$")) | .browser_download_url')
          curl -L -o chromium.zip "$CHROME_ZIP_URL"

      - name: Extract and decompress Chromium
        run: |
          mkdir -p layer/bin layer/fonts layer/swiftshader
          unzip chromium.zip -d tmp_chromium

          brotli -d $(find tmp_chromium -name chromium.br | head -n1) -o layer/bin/chrome
          chmod +x layer/bin/chrome

          brotli -d $(find tmp_chromium -name fonts.tar.br | head -n1) -o fonts.tar
          tar -xf fonts.tar -C layer/fonts
          rm fonts.tar

          if find tmp_chromium -name swiftshader.tar.br | grep -q .; then
            brotli -d $(find tmp_chromium -name swiftshader.tar.br | head -n1) -o swiftshader.tar
            tar -xf swiftshader.tar -C layer/swiftshader
            rm swiftshader.tar
          fi

      - name: Build Playwright Python layer
        run: |
          docker run --rm -v "$PWD:/work" python:3.10-slim bash -c '
            set -ex
            apt-get update && apt-get install -y zip && apt-get clean
            mkdir -p /work/layer/python
            python3 -m pip install playwright==1.41.2 -t /work/layer/python
            export PYTHONPATH=/work/layer/python
            python3 -m playwright install chromium
            rm -rf /root/.cache/ms-playwright
            cd /work/layer
            zip -9 -r /work/playwright-layer.zip python
          '

      - name: Build Chromium layer
        run: |
          cd layer
          zip -9 -r ../headless-chrome-layer.zip bin fonts swiftshader

      - name: Upload Playwright layer
        uses: actions/upload-artifact@v4
        with:
          name: playwright-layer
          path: playwright-layer.zip

      - name: Upload Chromium layer
        uses: actions/upload-artifact@v4
        with:
          name: chromium-layer
          path: headless-chrome-layer.zip

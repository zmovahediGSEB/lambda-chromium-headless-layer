name: Build Playwright + Chromium Lambda Layers

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-layers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Install host tools (GitHub runner)
      # ------------------------------------------------------------
      - name: Install host dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq unzip brotli tar zip

      # ------------------------------------------------------------
      # Download Sparticuz Chromium (Lambda-compatible)
      # ------------------------------------------------------------
      - name: Download Sparticuz Chromium layer
        run: |
          RELEASE_JSON=$(curl -s https://api.github.com/repos/Sparticuz/chromium/releases/latest)
          CHROME_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("layer\\.x64\\.zip$")) | .browser_download_url')

          echo "Chromium URL: $CHROME_URL"
          curl -L -o chromium-layer.zip "$CHROME_URL"

      # ------------------------------------------------------------
      # Extract & prepare Chromium layer
      # ------------------------------------------------------------
      - name: Build Chromium Lambda layer
        run: |
          mkdir -p chromium-layer/bin chromium-layer/fonts chromium-layer/swiftshader
          unzip chromium-layer.zip -d chromium_tmp

          # Chromium binary
          brotli -d $(find chromium_tmp -name chromium.br | head -n1) -o chromium-layer/bin/chrome
          chmod +x chromium-layer/bin/chrome

          # Fonts
          brotli -d $(find chromium_tmp -name fonts.tar.br | head -n1) -o fonts.tar
          tar -xf fonts.tar -C chromium-layer/fonts
          rm fonts.tar

          # SwiftShader (optional but recommended)
          if find chromium_tmp -name swiftshader.tar.br | grep -q .; then
            brotli -d $(find chromium_tmp -name swiftshader.tar.br | head -n1) -o swiftshader.tar
            tar -xf swiftshader.tar -C chromium-layer/swiftshader
            rm swiftshader.tar
          fi

          cd chromium-layer
          zip -9 -r ../headless-chrome-layer.zip bin fonts swiftshader

      - name: Build Playwright Python layer (Lambda Python 3.10)
        run: |
          docker run --rm -v "$PWD:/work" --entrypoint /bin/bash public.ecr.aws/lambda/python:3.10 -c '
            set -ex
      
            cat /etc/os-release
            python --version
      
            yum install -y zip
      
            mkdir -p /work/playwright-layer/python
      
            pip install --upgrade pip
            pip install playwright==1.39.0 -t /work/playwright-layer/python
      
            export PYTHONPATH=/work/playwright-layer/python
            python -m playwright install chromium
      
            # Remove browser binaries, keep driver
            rm -rf /root/.cache/ms-playwright
      
            cd /work/playwright-layer
            zip -9 -r /work/playwright-layer.zip python
          '

      # ------------------------------------------------------------
      # Upload artifacts
      # ------------------------------------------------------------
      - name: Upload Playwright layer
        uses: actions/upload-artifact@v4
        with:
          name: playwright-layer
          path: playwright-layer.zip

      - name: Upload Chromium layer
        uses: actions/upload-artifact@v4
        with:
          name: chromium-layer
          path: headless-chrome-layer.zip
